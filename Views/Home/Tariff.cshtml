@{
    ViewData["Title"] = "Tariff Data";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<div class="container my-5">
    <h2 class="mb-4 text-primary">
        <i class="bi bi-cash-stack"></i> Tariff Data
    </h2>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <button id="addTariffBtn" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Add Tariff
        </button>
    </div>

    <!-- Tariff Table -->
    <table class="table table-bordered table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Effective From</th>
                <th>Effective To</th>
                <th>Base Rate</th>
                <th>Tax Rate</th>
                <th style="width: 150px;">Actions</th>
            </tr>
        </thead>
        <tbody id="tariffTableBody">
            <tr>
                <td colspan="7" class="text-center text-muted">Loading tariffs...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Add/Edit Tariff Modal -->
<div class="modal fade" id="tariffModal" tabindex="-1" aria-labelledby="tariffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="tariffModalLabel">Add Tariff</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="tariffForm">
                    <input type="hidden" id="tariffId" />

                    <div class="mb-3">
                        <label class="form-label">Tariff Name</label>
                        <input type="text" id="name" class="form-control" placeholder="Enter Tariff Name" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Effective From</label>
                        <input type="date" id="effectiveFrom" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Effective To (Optional)</label>
                        <input type="date" id="effectiveTo" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Base Rate</label>
                        <input type="number" id="baseRate" step="0.01" class="form-control" placeholder="Enter Base Rate" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tax Rate</label>
                        <input type="number" id="taxRate" step="0.01" class="form-control" placeholder="Enter Tax Rate (e.g. 0.18)" required />
                    </div>

                    <button type="submit" class="btn btn-primary w-100 mt-2">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const tariffApi = "https://localhost:7071/api/Tariff_App";

    $(document).ready(function () {
        loadTariffs();

        // 🔹 Load all tariffs
        function loadTariffs() {
            $.get(`${tariffApi}/get-tariffs`, function (data) {
                if (!data || data.length === 0) {
                    $("#tariffTableBody").html('<tr><td colspan="7" class="text-center text-muted">No tariffs found.</td></tr>');
                    return;
                }

                let rows = "";
                data.forEach(t => {
                    rows += `
                        <tr>
                            <td>${t.tariffId}</td>
                            <td>${t.name}</td>
                            <td>${t.effectiveFrom ? new Date(t.effectiveFrom).toISOString().split('T')[0] : '-'}</td>
                            <td>${t.effectiveTo ? new Date(t.effectiveTo).toISOString().split('T')[0] : '-'}</td>
                            <td>${t.baseRate.toFixed(2)}</td>
                            <td>${(t.taxRate * 100).toFixed(1)}%</td>
                            <td>
                                <button class="btn btn-warning btn-sm edit-btn" data-id="${t.tariffId}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-danger btn-sm delete-btn" data-id="${t.tariffId}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>`;
                });
                $("#tariffTableBody").html(rows);
            }).fail(() => {
                alert("Error loading tariffs.");
            });
        }

        // 🔹 Open Add modal
        $("#addTariffBtn").click(function () {
            $("#tariffModalLabel").text("Add Tariff");
            $("#tariffForm")[0].reset();
            $("#tariffId").val("");
            $("#tariffModal").modal("show");
        });

        // 🔹 Submit form (Add or Update)
        $("#tariffForm").submit(function (e) {
            e.preventDefault();

            const formatDateOnly = (dateStr) => {
                if (!dateStr) return null;
                return new Date(dateStr).toISOString().split('T')[0];
            };

            const id = $("#tariffId").val();

            // build tariff object
            const tariff = {
                name: $("#name").val(),
                effectiveFrom: formatDateOnly($("#effectiveFrom").val()),
                effectiveTo: formatDateOnly($("#effectiveTo").val()),
                baseRate: parseFloat($("#baseRate").val()),
                taxRate: parseFloat($("#taxRate").val())
            };

            // only include tariffId if updating
            if (id) tariff.tariffId = parseInt(id);

            const url = id ? `${tariffApi}/update-tariff/${id}` : `${tariffApi}/add-tariff`;
            const method = id ? "PUT" : "POST";

            $.ajax({
                url: url,
                type: method,
                contentType: "application/json",
                data: JSON.stringify(tariff),
                success: function () {
                    $("#tariffModal").modal("hide");
                    loadTariffs();
                },
                error: function (xhr) {
                    console.error(xhr.responseText);
                    alert("Error saving tariff. Please check the data format.");
                }
            });
        });

        // 🔹 Edit tariff
        $(document).on("click", ".edit-btn", function () {
            const id = $(this).data("id");

            $.get(`${tariffApi}/get-tariff-by-id/${id}`, function (t) {
                $("#tariffModalLabel").text("Edit Tariff");
                $("#tariffId").val(t.tariffId);
                $("#name").val(t.name);
                $("#effectiveFrom").val(t.effectiveFrom ? new Date(t.effectiveFrom).toISOString().split('T')[0] : "");
                $("#effectiveTo").val(t.effectiveTo ? new Date(t.effectiveTo).toISOString().split('T')[0] : "");
                $("#baseRate").val(t.baseRate);
                $("#taxRate").val(t.taxRate);
                $("#tariffModal").modal("show");
            }).fail(() => {
                alert("Error loading tariff details.");
            });
        });

        // 🔹 Delete tariff
        $(document).on("click", ".delete-btn", function () {
            const id = $(this).data("id");
            if (!confirm("Are you sure you want to delete this tariff?")) return;

            $.ajax({
                url: `${tariffApi}/delete-tariff/${id}`,
                type: "DELETE",
                success: function () {
                    loadTariffs();
                },
                error: function () {
                    alert("Error deleting tariff.");
                }
            });
        });
    });
</script>
