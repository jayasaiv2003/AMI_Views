@{
    ViewData["Title"] = "Consumer Management";
}

<!-- Bootstrap & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<div class="container mt-5">
    <div class="text-center mb-4">
        <h3 class="text-primary fw-bold">
            <i class="bi bi-people"></i> Consumer Management
        </h3>
        <p class="text-muted">Manage consumer information, update details, and view records efficiently.</p>
    </div>

    <!-- Add / Update Consumer Form -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-primary text-white fw-semibold">
            <i class="bi bi-person-plus"></i> Add / Update Consumer
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" id="consumerId" class="form-control" placeholder="Consumer ID (for update)" />
                </div>
                <div class="col-md-4">
                    <input type="text" id="name" class="form-control" placeholder="Name" />
                </div>
                <div class="col-md-4">
                    <input type="text" id="phone" class="form-control" placeholder="Phone" />
                </div>
                <div class="col-md-6">
                    <input type="email" id="email" class="form-control" placeholder="Email" />
                </div>
                <div class="col-md-6">
                    <input type="text" id="address" class="form-control" placeholder="Address" />
                </div>
                <div class="col-md-3">
                    <select id="status" class="form-select">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-9 d-flex gap-2">
                    <button id="btnAdd" class="btn btn-success flex-fill">
                        <i class="bi bi-plus-circle"></i> Add
                    </button>
                    <button id="btnUpdate" class="btn btn-warning flex-fill">
                        <i class="bi bi-pencil-square"></i> Update
                    </button>
                    <button id="btnClear" class="btn btn-secondary flex-fill">
                        <i class="bi bi-x-circle"></i> Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search & Table -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list-ul"></i> Consumers List</span>
            <div class="d-flex align-items-center gap-2">
                <input type="text" id="searchBox" class="form-control form-control-sm" placeholder="🔍 Search by ID or Name" style="width: 220px;">
                <button id="btnSearchClear" class="btn btn-sm btn-light text-dark">
                    <i class="bi bi-x-circle"></i> Clear
                </button>
            </div>
        </div>
        <div class="card-body table-responsive">
            <table class="table table-hover table-bordered align-middle" id="tblConsumers">
                <thead class="table-primary text-center">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Address</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody class="text-center"></tbody>
            </table>

            <!-- Pagination Controls -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted small" id="pageInfo"></div>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    const API_BASE = "https://localhost:7071/api/Consumer_App";
    
    

    let allConsumers = [];
    let filteredConsumers = [];
    let currentPage = 1;
    const pageSize = 4;

    $(document).ready(function () {
        loadConsumers();

        // Load all consumers
        function loadConsumers() {
            $.get(`${API_BASE}/all`, function (data) {
                allConsumers = data;
                filteredConsumers = data;
                renderTable();
                renderPagination();
            });
        }

        // Render table with pagination
        function renderTable() {
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pagedData = filteredConsumers.slice(start, end);

            let rows = "";
            pagedData.forEach(c => {
                rows += `
                    <tr>
                        <td>${c.consumerId}</td>
                        <td>${c.name}</td>
                        <td>${c.phone}</td>
                        <td>${c.email}</td>
                        <td>${c.address}</td>
                        <td>
                            <span class="badge ${c.status === "Active" ? "bg-success" : "bg-secondary"}">${c.status}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info btn-edit" data-id="${c.consumerId}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-delete" data-id="${c.consumerId}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>`;
            });
            $("#tblConsumers tbody").html(rows);

            // Update page info
            const totalPages = Math.ceil(filteredConsumers.length / pageSize);
            $("#pageInfo").text(`Page ${currentPage} of ${totalPages} (${filteredConsumers.length} records total)`);
        }

        // Render pagination buttons
        function renderPagination() {
            const totalPages = Math.ceil(filteredConsumers.length / pageSize);
            let buttons = "";

            if (totalPages <= 1) {
                $("#pagination").html("");
                return;
            }

            for (let i = 1; i <= totalPages; i++) {
                buttons += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#">${i}</a>
                    </li>`;
            }
            $("#pagination").html(buttons);
        }

        // Handle page click
        $(document).on("click", "#pagination .page-link", function (e) {
            e.preventDefault();
            currentPage = parseInt($(this).text());
            renderTable();
            renderPagination();
        });

        // Search consumers by ID or name
        $("#searchBox").on("keyup", function () {
            const keyword = $(this).val().toLowerCase();
            filteredConsumers = allConsumers.filter(c =>
                c.name.toLowerCase().includes(keyword) || c.consumerId.toString().includes(keyword)
            );
            currentPage = 1;
            renderTable();
            renderPagination();
        });

        // Clear search
        $("#btnSearchClear").click(function () {
            $("#searchBox").val("");
            filteredConsumers = allConsumers;
            currentPage = 1;
            renderTable();
            renderPagination();
        });

        // Add Consumer
        $("#btnAdd").click(function () {
            const consumer = getFormData();
            $.ajax({
                url: `${API_BASE}/add`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(consumer),
                success: function () {
                    alert("✅ Consumer added successfully!");
                    clearForm();
                    loadConsumers();
                },
                error: () => alert("❌ Error adding consumer")
            });
        });

        // Update Consumer
        $("#btnUpdate").click(function () {
            const consumer = getFormData();
            $.ajax({
                url: `${API_BASE}/update`,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(consumer),
                success: function () {
                    alert("✅ Consumer updated successfully!");
                    clearForm();
                    loadConsumers();
                },
                error: () => alert("❌ Error updating consumer")
            });
        });

        // Delete Consumer
        $(document).on("click", ".btn-delete", function () {
            const id = $(this).data("id");
            if (confirm("Are you sure to delete this consumer?")) {
                $.ajax({
                    url: `${API_BASE}/delete/${id}`,
                    type: "DELETE",
                    success: function () {
                        alert("🗑️ Deleted successfully!");
                        loadConsumers();
                    },
                    error: () => alert("❌ Error deleting consumer")
                });
            }
        });

        // Edit Consumer
        $(document).on("click", ".btn-edit", function () {
            const id = $(this).data("id");
            $.get(`${API_BASE}/${id}`, function (c) {
                $("#consumerId").val(c.consumerId);
                $("#name").val(c.name);
                $("#phone").val(c.phone);
                $("#email").val(c.email);
                $("#address").val(c.address);
                $("#status").val(c.status);
            });
        });

        // Helpers
        function getFormData() {
            return {
                consumerId: $("#consumerId").val() ? parseInt($("#consumerId").val()) : 0,
                name: $("#name").val(),
                address: $("#address").val(),
                phone: $("#phone").val(),
                email: $("#email").val(),
                status: $("#status").val(),
                createdBy: "admin"
            };
        }

        function clearForm() {
            $("#consumerId, #name, #phone, #email, #address").val("");
            $("#status").val("Active");
        }

        $("#btnClear").click(clearForm);
    });
</script>
