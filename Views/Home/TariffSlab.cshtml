@{
    ViewData["Title"] = "Tariff Slab Data";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<div class="container my-5">
    <h2 class="mb-4 text-primary">
        <i class="bi bi-bar-chart"></i> Tariff Slab Data
    </h2>

    <!-- Select Tariff -->
    <div class="row mb-4 align-items-end">
        <div class="col-md-4">
            <label class="form-label fw-semibold">Select Tariff:</label>
            <select id="tariffSelect" class="form-select">
                <option value="">-- Select a Tariff --</option>
            </select>
        </div>
        <div class="col-md-4">
            <button id="addSlabBtn" class="btn btn-success mt-3 w-50" disabled>
                <i class="bi bi-plus-circle"></i> Add Slab
            </button>
        </div>
    </div>

    <!-- Slab Table -->
    <table class="table table-bordered table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>Slab ID</th>
                <th>From (kWh)</th>
                <th>To (kWh)</th>
                <th>Rate per kWh</th>
                <th style="width:120px;">Actions</th>
            </tr>
        </thead>
        <tbody id="slabTableBody">
            <tr>
                <td colspan="5" class="text-center text-muted">Please select a tariff to load slabs...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Add Slab Modal -->
<div class="modal fade" id="slabModal" tabindex="-1" aria-labelledby="slabModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="slabModalLabel">Add Tariff Slab</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="slabForm">
                    <div class="mb-3">
                        <label class="form-label">From (kWh)</label>
                        <input type="number" id="fromKwh" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">To (kWh)</label>
                        <input type="number" id="toKwh" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rate per kWh</label>
                        <input type="number" id="ratePerKwh" class="form-control" required />
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save Slab</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const tariffApi = "https://localhost:7071/api/Tariff_App";
    const slabApi = "https://localhost:7071/api/TariffSlab_App";
    let selectedTariffId = null;

    $(document).ready(function () {
        loadTariffs();

        // Load all tariffs into dropdown
        function loadTariffs() {
            $.get(`${tariffApi}/get-tariffs`, function (tariffs) {
                $("#tariffSelect").empty().append('<option value="">-- Select a Tariff --</option>');
                tariffs.forEach(t => {
                    $("#tariffSelect").append(`<option value="${t.tariffId}">${t.name}</option>`);
                });
            }).fail(function () {
                alert("Error loading tariffs!");
            });
        }

        // When tariff changes
        $("#tariffSelect").change(function () {
            selectedTariffId = $(this).val();
            $("#addSlabBtn").prop("disabled", !selectedTariffId);
            loadSlabs(selectedTariffId);
        });

        // Load slabs for selected tariff
        function loadSlabs(tariffId) {
            if (!tariffId) {
                $("#slabTableBody").html('<tr><td colspan="5" class="text-center text-muted">Please select a tariff...</td></tr>');
                return;
            }

            $.get(`${slabApi}/tariff/${tariffId}`, function (slabs) {
                if (slabs.length === 0) {
                    $("#slabTableBody").html('<tr><td colspan="5" class="text-center text-muted">No slabs found for this tariff.</td></tr>');
                    return;
                }

                let rows = "";
                slabs.forEach(s => {
                    rows += `
                        <tr>
                            <td>${s.tariffSlabId}</td>
                            <td>${s.fromKwh.toFixed(2)}</td>
                            <td>${s.toKwh.toFixed(2)}</td>
                            <td>${s.ratePerKwh.toFixed(2)}</td>
                            <td>
                                <button class="btn btn-danger btn-sm delete-btn" data-id="${s.tariffSlabId}">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        </tr>`;
                });
                $("#slabTableBody").html(rows);
            }).fail(function () {
                alert("Error loading slabs!");
            });
        }

        // Open modal
        $("#addSlabBtn").click(function () {
            $("#slabForm")[0].reset();
            $("#slabModal").modal("show");
        });

        // Add slab
        $("#slabForm").submit(function (e) {
            e.preventDefault();

            const newSlab = {
                tariffId: parseInt(selectedTariffId),
                fromKwh: parseFloat($("#fromKwh").val()),
                toKwh: parseFloat($("#toKwh").val()),
                ratePerKwh: parseFloat($("#ratePerKwh").val())
            };

            $.ajax({
                url: `${slabApi}/add`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(newSlab),
                success: function () {
                    $("#slabModal").modal("hide");
                    loadSlabs(selectedTariffId);
                },
                error: function () {
                    alert("Error adding slab!");
                }
            });
        });

        // Delete slab
        $(document).on("click", ".delete-btn", function () {
            const slabId = $(this).data("id");
            if (!confirm("Are you sure you want to delete this slab?")) return;

            $.ajax({
                url: `${slabApi}/delete/${slabId}`,
                type: "DELETE",
                success: function () {
                    loadSlabs(selectedTariffId);
                },
                error: function () {
                    alert("Error deleting slab!");
                }
            });
        });
    });
</script>
