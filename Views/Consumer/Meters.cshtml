@{
    ViewData["Title"] = "My Meters";
    Layout = "~/Views/Shared/_Layout_Consumer.cshtml";
}

<div class="container my-5">
    <h3 class="mb-4 text-primary fw-bold">
        ⚡ My Meters
    </h3>
    <div id="meterList" class="row"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(async function () {
        const token = localStorage.getItem("jwtToken");
        if (!token) {
            window.location.href = "/Auth/ConsumerLogin";
            return;
        }

        try {
            // 🔹 Fetch both meters and tariffs in parallel
            const [meters, tariffs] = await Promise.all([
                $.ajax({
                    url: "https://localhost:7071/api/ConsumerDashboard/meters",
                    type: "GET",
                    headers: { "Authorization": "Bearer " + token }
                }),
                $.ajax({
                    url: "https://localhost:7071/api/Tariff_App/get-tariffs",
                    type: "GET",
                    headers: { "Authorization": "Bearer " + token }
                })
            ]);

            // 🔹 Handle single meter case
            const meterList = Array.isArray(meters) ? meters : [meters];

            // 🔹 Map tariffId to tariff name for easy lookup
            const tariffMap = {};
            tariffs.forEach(t => {
                tariffMap[t.tariffId] = t.name;
            });

            let html = ``;

            meterList.forEach(m => {
                const tariffName = tariffMap[m.tariffId] || "N/A";

                html += `
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <h5 class="card-title text-primary">${m.meterSerialNo}</h5>
                            <p class="mb-1"><b>IP:</b> ${m.ipAddress}</p>
                            <p class="mb-1"><b>ICCID:</b> ${m.iccid}</p>
                            <p class="mb-1"><b>IMSI:</b> ${m.imsi}</p>
                            <p class="mb-1"><b>Manufacturer:</b> ${m.manufacturer}</p>
                            <p class="mb-1"><b>Firmware:</b> ${m.firmware}</p>
                            <p class="mb-1"><b>Category:</b> ${m.category}</p>
                            <p class="mb-1"><b>Installed On:</b> ${new Date(m.installTsUtc).toLocaleDateString()}</p>
                            <p class="mb-1"><b>Status:</b> ${m.status}</p>
                            <p class="mb-1"><b>Tariff:</b> <span class="badge bg-success">${tariffName}</span></p>
                        </div>
                    </div>
                </div>`;
            });

            $("#meterList").html(html);

        } catch (error) {
            console.error("Error fetching data:", error);
            $("#meterList").html(`<p class="text-danger">❌ Error fetching meters or tariffs.</p>`);
        }
    });
</script>
