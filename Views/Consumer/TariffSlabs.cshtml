@{
    ViewData["Title"] = "Tariff Slab Data";
    Layout = "~/Views/Shared/_Layout_Consumer.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<div class="container my-5">
    <h2 class="mb-4 text-primary">
        <i class="bi bi-bar-chart"></i> Tariff Slab Data
    </h2>

    <!-- Select Tariff -->
    <div class="row mb-4 align-items-end">
        <div class="col-md-4">
            <label class="form-label fw-semibold">Select Tariff:</label>
            <select id="tariffSelect" class="form-select">
                <option value="">-- Select a Tariff --</option>
            </select>
        </div>
    </div>

    <!-- Slab Table -->
    <table class="table table-bordered table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>Slab ID</th>
                <th>From (kWh)</th>
                <th>To (kWh)</th>
                <th>Rate per kWh</th>
            </tr>
        </thead>
        <tbody id="slabTableBody">
            <tr>
                <td colspan="4" class="text-center text-muted">Please select a tariff to load slabs...</td>
            </tr>
        </tbody>
    </table>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const tariffApi = "https://localhost:7071/api/Tariff_App";
    const slabApi = "https://localhost:7071/api/TariffSlab_App";

    $(document).ready(function () {
        loadTariffs();

        // Load all tariffs into dropdown
        function loadTariffs() {
            $.get(`${tariffApi}/get-tariffs`, function (tariffs) {
                $("#tariffSelect").empty().append('<option value="">-- Select a Tariff --</option>');
                tariffs.forEach(t => {
                    $("#tariffSelect").append(`<option value="${t.tariffId}">${t.name}</option>`);
                });
            }).fail(function () {
                alert("Error loading tariffs!");
            });
        }

        // When tariff changes, load its slabs
        $("#tariffSelect").change(function () {
            const selectedTariffId = $(this).val();
            loadSlabs(selectedTariffId);
        });

        // Load slabs for selected tariff
        function loadSlabs(tariffId) {
            if (!tariffId) {
                $("#slabTableBody").html('<tr><td colspan="4" class="text-center text-muted">Please select a tariff...</td></tr>');
                return;
            }

            $.get(`${slabApi}/tariff/${tariffId}`, function (slabs) {
                if (!slabs || slabs.length === 0) {
                    $("#slabTableBody").html('<tr><td colspan="4" class="text-center text-muted">No slabs found for this tariff.</td></tr>');
                    return;
                }

                let rows = "";
                slabs.forEach(s => {
                    rows += `
                        <tr>
                            <td>${s.tariffSlabId}</td>
                            <td>${s.fromKwh.toFixed(2)}</td>
                            <td>${s.toKwh.toFixed(2)}</td>
                            <td>${s.ratePerKwh.toFixed(2)}</td>
                        </tr>`;
                });
                $("#slabTableBody").html(rows);
            }).fail(function () {
                alert("Error loading slabs!");
            });
        }
    });
</script>
