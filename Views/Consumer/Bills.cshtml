@{
    ViewData["Title"] = "My Bills";
    Layout = "~/Views/Shared/_Layout_Consumer.cshtml";
}

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-primary fw-bold">
            <i class="bi bi-receipt"></i> My Bills
        </h3>
        <div class="d-flex gap-2">
            <!-- 🔍 Month Filter -->
            <input type="month" id="monthFilter" class="form-control form-control-sm" />

            <!-- 🧾 Status Filter -->
            <select id="statusFilter" class="form-select form-select-sm">
                <option value="">All</option>
                <option value="Paid">Paid</option>
                <option value="Unpaid">Unpaid</option>
            </select>

            <!-- 🔁 Refresh -->
            <button id="refreshBtn" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body table-responsive">
            <table class="table table-hover align-middle text-center" id="billsTable">
                <thead class="table-primary">
                    <tr>
                        <th>Bill ID</th>
                        <th>Meter</th>
                        <th>Month</th>
                        <th>Total Units (kWh)</th>
                        <th>Base Rate (₹)</th>
                        <th>Tax Rate (₹)</th>
                        <th>Total (₹)</th>
                        <th>Status</th>
                        <th>Due</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <!-- Pagination Controls -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <small id="pageInfo" class="text-muted"></small>
                <div>
                    <button id="prevPage" class="btn btn-outline-primary btn-sm me-2">Previous</button>
                    <button id="nextPage" class="btn btn-outline-primary btn-sm">Next</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery + Bootstrap -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {
        const token = localStorage.getItem("jwtToken");
        if (!token) {
            window.location.href = "/Auth/ConsumerLogin";
            return;
        }

        let allBills = [];
        let currentPage = 1;
        const pageSize = 5; // ✅ 5 records per page

        // Load bills initially
        loadBills();

        // Refresh button
        $("#refreshBtn").click(loadBills);

        // Apply filters
        $("#monthFilter, #statusFilter").on("change", applyFilters);

        // Pagination buttons
        $("#prevPage").click(() => {
            if (currentPage > 1) {
                currentPage--;
                renderBills(getPaginatedData(allBills));
            }
        });

        $("#nextPage").click(() => {
            const totalPages = Math.ceil(allBills.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                renderBills(getPaginatedData(allBills));
            }
        });

        // Fetch bills
        function loadBills() {
            $.ajax({
                url: "https://localhost:7071/api/ConsumerDashboard/bills",
                type: "GET",
                headers: { "Authorization": "Bearer " + token },
                success: function (bills) {
                    allBills = Array.isArray(bills) ? bills : [bills];
                    currentPage = 1;
                    renderBills(getPaginatedData(allBills));
                },
                error: function () {
                    $("#billsTable tbody").html(`
                        <tr>
                            <td colspan="10" class="text-danger">❌ Error fetching bills</td>
                        </tr>`);
                }
            });
        }

        // Apply search and filters
        function applyFilters() {
            let filtered = allBills;

            const selectedMonth = $("#monthFilter").val();
            const status = $("#statusFilter").val();

            if (selectedMonth) {
                const [year, month] = selectedMonth.split("-");
                filtered = filtered.filter(b => {
                    const billDate = new Date(b.billingMonth);
                    return (
                        billDate.getFullYear() == year &&
                        (billDate.getMonth() + 1) == parseInt(month)
                    );
                });
            }

            if (status) {
                filtered = filtered.filter(b => b.status === status);
            }

            currentPage = 1;
            renderBills(getPaginatedData(filtered));
        }

        // Pagination logic
        function getPaginatedData(data) {
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = data.slice(start, end);

            const totalPages = Math.ceil(data.length / pageSize);
            $("#pageInfo").text(`Page ${currentPage} of ${totalPages || 1}`);

            $("#prevPage").prop("disabled", currentPage === 1);
            $("#nextPage").prop("disabled", currentPage >= totalPages);

            return pageData;
        }

        // Render table
        function renderBills(bills) {
            if (!Array.isArray(bills)) bills = [bills];
            if (bills.length === 0) {
                $("#billsTable tbody").html(`
                    <tr>
                        <td colspan="10" class="text-muted">No bills found.</td>
                    </tr>`);
                $("#pageInfo").text("");
                return;
            }

            let rows = "";
            bills.forEach(b => {
                const statusBadge = b.status === "Paid"
                    ? `<span class="badge bg-success">Paid</span>`
                    : `<span class="badge bg-danger">Unpaid</span>`;

                const payButton = b.status === "Paid"
                    ? `<button class="btn btn-success btn-sm" disabled><i class="bi bi-check2-circle"></i> Paid</button>`
                    : `<button class="btn btn-outline-success btn-sm btn-pay"
                            data-id="${b.billId}"
                            data-month="${b.billingMonth}">
                            <i class="bi bi-cash-coin"></i> Pay
                       </button>`;

                rows += `
                    <tr>
                        <td>${b.billId}</td>
                        <td>${b.meterSerialNo}</td>
                        <td>${new Date(b.billingMonth).toLocaleDateString("en-GB", { year: "numeric", month: "short" })}</td>
                        <td>${b.totalKwh.toFixed(2)}</td>
                        <td>₹${b.baseRateApplied.toFixed(2)}</td>
                        <td>₹${b.slabCharge.toFixed(2)}</td>
                        <td><strong>₹${b.totalBillAmount.toFixed(2)}</strong></td>
                        <td>${statusBadge}</td>
                        <td>${new Date(b.dueDate).toLocaleDateString("en-GB")}</td>
                        <td>${payButton}</td>
                    </tr>`;
            });
            $("#billsTable tbody").html(rows);
        }

        // 🧾 Pay button
        $(document).on("click", ".btn-pay", function () {
            const billId = $(this).data("id");
            const month = $(this).data("month");

            if (!confirm("💳 Are you sure you want to pay this bill?")) return;

            const payload = {
                month: month,
                billId: billId
            };

            $.ajax({
                url: "https://localhost:7071/api/ConsumerDashboard/bills/pay",
                type: "PUT",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                },
                data: JSON.stringify(payload),
                success: function (res) {
                    alert("✅ " + res.message);
                    loadBills(); // refresh
                },
                error: function (xhr) {
                    const msg = xhr.responseText || "❌ Payment failed.";
                    alert(msg);
                }
            });
        });
    });
</script>
