@{
    ViewData["Title"] = "Consumer Dashboard";
    Layout = "~/Views/Shared/_Layout_Consumer.cshtml";
}

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-primary fw-bold">
            <i class="bi bi-person-circle"></i> Profile
        </h3>
        <div class="d-flex gap-2">
            <button id="editBtn" class="btn btn-outline-warning btn-sm" style="display:none;">
                <i class="bi bi-pencil-square"></i> Edit
            </button>
            <button id="refreshBtn" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    <div id="profileCard" class="card shadow-lg border-0 rounded-3">
        <div class="card-body p-4 text-center text-muted">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3">Loading profile...</p>
        </div>
    </div>
</div>

<!-- 🟡 Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-semibold"><i class="bi bi-pencil-square"></i> Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Name</label>
                        <input type="text" id="editName" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Email</label>
                        <input type="email" id="editEmail" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Phone</label>
                        <input type="text" id="editPhone" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Address</label>
                        <textarea id="editAddress" class="form-control" rows="2" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Status</label>
                        <select id="editStatus" class="form-select">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="saveEditBtn" class="btn btn-warning"><i class="bi bi-save"></i> Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap & jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {
        const token = localStorage.getItem("jwtToken");
        const API_BASE = "https://localhost:7071/api/Consumer_App"; // same as management routes
        let currentProfile = null;

        if (!token) {
            window.location.href = "/Auth/ConsumerLogin";
            return;
        }

        loadProfile();

        $("#refreshBtn").click(loadProfile);

        // Load Profile
        function loadProfile() {
            $("#profileCard").html(`
                <div class="card-body p-4 text-center text-muted">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">Loading profile...</p>
                </div>
            `);

            $.ajax({
                url: "https://localhost:7071/api/ConsumerDashboard/profile",
                type: "GET",
                headers: { "Authorization": "Bearer " + token },
                success: function (data) {
                    currentProfile = data;
                    $("#editBtn").show();

                    $("#profileCard").html(`
                        <div class="card-body p-4">
                            <div class="row">
                                <div class="col-md-4 text-center mb-3">
                                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center"
                                         style="width: 100px; height: 100px;">
                                        <i class="bi bi-person-fill text-primary" style="font-size: 3rem;"></i>
                                    </div>
                                    <h5 class="mt-3 text-primary fw-bold">${data.name}</h5>
                                    <span class="badge ${data.status === 'Active' ? 'bg-success' : 'bg-secondary'}">
                                        ${data.status}
                                    </span>
                                </div>
                                <div class="col-md-8">
                                    <table class="table table-borderless mb-0">
                                        <tbody>
                                            <tr><th class="text-muted w-25"><i class="bi bi-hash"></i> ID</th><td>${data.consumerId}</td></tr>
                                            <tr><th class="text-muted"><i class="bi bi-envelope"></i> Email</th><td>${data.email}</td></tr>
                                            <tr><th class="text-muted"><i class="bi bi-telephone"></i> Phone</th><td>${data.phone}</td></tr>
                                            <tr><th class="text-muted"><i class="bi bi-geo-alt"></i> Address</th><td>${data.address}</td></tr>
                                            <tr><th class="text-muted"><i class="bi bi-calendar3"></i> Created</th><td>${new Date(data.createdAt).toLocaleString()}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `);
                },
                error: function () {
                    $("#profileCard").html(`
                        <div class='card-body text-center text-danger py-5'>
                            <i class="bi bi-exclamation-triangle fs-3"></i>
                            <p class="mt-2 mb-0">Error fetching profile</p>
                        </div>
                    `);
                }
            });
        }

        // 🟡 Open edit modal
        $("#editBtn").click(function () {
            if (!currentProfile) return;

            $("#editName").val(currentProfile.name);
            $("#editEmail").val(currentProfile.email);
            $("#editPhone").val(currentProfile.phone);
            $("#editAddress").val(currentProfile.address);
            $("#editStatus").val(currentProfile.status);

            const modal = new bootstrap.Modal(document.getElementById("editModal"));
            modal.show();
        });

        // 🟢 Save changes
        $("#saveEditBtn").click(function () {
            const updatedData = {
                consumerId: currentProfile.consumerId,
                name: $("#editName").val(),
                email: $("#editEmail").val(),
                phone: $("#editPhone").val(),
                address: $("#editAddress").val(),
                status: $("#editStatus").val(),
                createdBy: "consumer" // or "admin" if needed
            };

            $.ajax({
                url: `${API_BASE}/update`,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(updatedData),
                headers: { "Authorization": "Bearer " + token },
                success: function () {
                    alert("✅ Profile updated successfully!");
                    $("#editModal").modal("hide");
                    loadProfile();
                },
                error: () => alert("❌ Error updating profile")
            });
        });
    });
</script>
